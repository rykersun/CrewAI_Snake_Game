import os
from dotenv import load_dotenv
from crewai import Agent, Task, Crew, Process
from crewai_tools import SerperDevTool
from crewai.llm import LLM

# --------------------------------------------------
# 1. è¼‰å…¥ .env æª”æ¡ˆä¸­çš„ç’°å¢ƒè®Šæ•¸
# --------------------------------------------------
load_dotenv()

# å¾ .env è®€å– API Keys å’Œè¨­å®š
google_api_key = os.getenv("GOOGLE_API_KEY")
serper_api_key = os.getenv("SERPER_API_KEY")
model_name = os.getenv("GEMINI_MODEL_NAME",
                       "gemini-2.5-pro")  # å¦‚æœæœªè¨­å®šï¼Œé è¨­ç‚º 1.5 pro

# æª¢æŸ¥å¿…è¦çš„ API Keys
if not google_api_key:
    raise ValueError("GOOGLE_API_KEY ç’°å¢ƒè®Šæ•¸æœªè¨­å®šã€‚è«‹æª¢æŸ¥æ‚¨çš„ .env æª”æ¡ˆã€‚")
if not serper_api_key:
    raise ValueError("SERPER_API_KEY ç’°å¢ƒè®Šæ•¸æœªè¨­å®šã€‚è«‹æª¢æŸ¥æ‚¨çš„ .env æª”æ¡ˆã€‚")

# --------------------------------------------------
# 2. è¨­å®š LLM (Gemini) å’Œ Tools (Serper)
# --------------------------------------------------


gemini_llm = LLM(
    model=f"gemini/{model_name}",  # åƒé€™æ¨£ 'gemini/gemini-1.5-pro-latest'
    config={
        "api_key": google_api_key
    }
)

# è¨­å®š Serper æœå°‹å·¥å…·
# (é€™æœƒè‡ªå‹•ä½¿ç”¨ .env ä¸­è®€å–åˆ°çš„ SERPER_API_KEY)
search_tool = SerperDevTool()

# --------------------------------------------------
# 3. å®šç¾©æ‚¨çš„ Agents (ä»£ç†äºº)
# --------------------------------------------------

# å®šç¾©ä¸€å€‹å¸‚å ´ç ”ç©¶å“¡ (ç¾åœ¨å…·å‚™æœå°‹èƒ½åŠ›)
researcher = Agent(
    role='è³‡æ·±å¸‚å ´ç ”ç©¶å“¡',
    goal='æ‰¾å‡º 2025 å¹´æœ€å€¼å¾—é—œæ³¨çš„ AI è¶¨å‹¢',
    backstory="""æ‚¨æ˜¯ä¸€ä½ç¶“é©—è±å¯Œçš„å¸‚å ´ç ”ç©¶å“¡ï¼Œ
  å°ˆé–€åˆ†ææ–°èˆˆæŠ€è¡“ï¼Œä¸¦èƒ½ç²¾æº–é æ¸¬ä¸‹ä¸€å€‹é‡å¤§è¶¨å‹¢ã€‚
  æ‚¨æœƒä½¿ç”¨æ‚¨çš„ç¶²è·¯æœå°‹å·¥å…·ä¾†ç²å–æœ€æ–°è³‡è¨Šã€‚""",
    verbose=True,
    allow_delegation=False,
    llm=gemini_llm,
    tools=[search_tool]  # <-- åœ¨é€™è£¡åŠ å…¥æœå°‹å·¥å…·
)

# å®šç¾©ä¸€å€‹æŠ€è¡“ä½œå®¶
writer = Agent(
    role='å°ˆæ¥­æŠ€è¡“å…§å®¹ä½œå®¶',
    goal='æ’°å¯«ä¸€ç¯‡é—œæ–¼ 2025 å¹´ AI è¶¨å‹¢çš„å¼•äººå…¥å‹çš„éƒ¨è½æ ¼æ–‡ç« ',
    backstory="""æ‚¨æ˜¯ä¸€ä½çŸ¥åçš„æŠ€è¡“ä½œå®¶ï¼Œ
  æ“…é•·å°‡è¤‡é›œçš„ AI æ¦‚å¿µè½‰åŒ–ç‚ºæ˜“æ–¼ç†è§£ä¸”å¸å¼•äººçš„æ–‡ç« ã€‚
  æ‚¨çš„æ–‡ç« ç¸½æ˜¯èƒ½ç™»ä¸ŠæŠ€è¡“åª’é«”çš„é ­æ¢ã€‚""",
    verbose=True,
    allow_delegation=True,
    llm=gemini_llm
)

# --------------------------------------------------
# 4. å®šç¾©æ‚¨çš„ Tasks (ä»»å‹™)
# --------------------------------------------------

# ç ”ç©¶ä»»å‹™ (ç¾åœ¨æœƒä½¿ç”¨æœå°‹å·¥å…·)
task_research = Task(
    description="""ä½¿ç”¨æ‚¨çš„æœå°‹å·¥å…·ï¼Œåˆ†æç•¶å‰ AI é ˜åŸŸçš„ç™¼å±•ï¼Œ
  æ‰¾å‡º 5 å€‹åœ¨ 2025 å¹´å°‡æœƒçˆ†ç™¼æ€§æˆé•·çš„ AI è¶¨å‹¢ã€‚
  æä¾›æ¯å€‹è¶¨å‹¢çš„ç°¡è¦èªªæ˜åŠå…¶æ½›åœ¨å½±éŸ¿ã€‚""",
    expected_output="ä¸€ä»½åŒ…å« 5 å€‹ AI è¶¨å‹¢åŠå…¶åˆ†æçš„é‡é»å ±å‘Šã€‚",
    agent=researcher
)

# å¯«ä½œä»»å‹™
task_write = Task(
    description="""ä½¿ç”¨ç ”ç©¶å“¡æä¾›çš„é‡é»å ±å‘Šï¼Œ
  æ’°å¯«ä¸€ç¯‡ 500 å­—å·¦å³çš„éƒ¨è½æ ¼æ–‡ç« ã€‚
  æ–‡ç« é¢¨æ ¼æ‡‰å…·å‰ç»æ€§ã€å¸å¼•äººï¼Œä¸¦é©åˆå¤§çœ¾é–±è®€ã€‚""",
    expected_output="ä¸€ç¯‡æ ¼å¼å®Œæ•´ã€å¼•äººå…¥å‹çš„éƒ¨è½æ ¼æ–‡ç« ã€‚",
    agent=writer
)

# --------------------------------------------------
# 5. å»ºç«‹ä¸¦åŸ·è¡Œ Crew (åœ˜éšŠ)
# --------------------------------------------------

my_crew = Crew(
    agents=[researcher, writer],
    tasks=[task_research, task_write],
    process=Process.sequential,
    verbose=True
)

# --------------------------------------------------
# 6. å•Ÿå‹•ä»»å‹™
# --------------------------------------------------

print("==================================================")
print("ğŸš€ å•Ÿå‹• CrewAI ä»»å‹™ (ä½¿ç”¨ .env è¨­å®š)...")
print(f"ä½¿ç”¨æ¨¡å‹: {model_name}")
print("==================================================")

result = my_crew.kickoff()

print("\n\n==================================================")
print("âœ… ä»»å‹™å®Œæˆï¼")
print("==================================================")
print("æœ€çµ‚ç”¢å‡ºçµæœï¼š\n")
print(result)
